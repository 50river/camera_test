# 要件ドキュメント

## はじめに

このドキュメントは、ブラウザ内で完全に動作し、サーバー通信を一切必要としない（エッジ完結型）日本の領収書OCR Webアプリケーションの要件を定義します。このアプリケーションは、PaddleOCRの日本語軽量モデル（ONNX形式）とWASM推論を使用して、領収書やレシートから日付、支払先、金額、適用（利用内容）などの重要な情報を抽出します。システムは自動抽出を優先し、困難な箇所についてはタップ選択機能による手動アシストを提供します。

## 要件

### 要件 1

**ユーザーストーリー:** ユーザーとして、スマートフォンのカメラを使用して領収書画像を撮影または選択したい。これにより、別のカメラアプリを必要とせずに領収書情報をデジタル化できる。

#### 受け入れ基準

1. ユーザーがアプリケーションにアクセスした時、システムは `accept="image/*" capture="environment"` を持つHTMLファイル入力を提供してカメラを起動する
2. 画像が選択または撮影された時、システムは自動的にEXIF回転補正を適用する
3. 画像が読み込まれた時、システムは自動的に透視補正パラメータを推定する
4. 透視補正が必要な時、システムはユーザーが四隅のポイントをドラッグして手動で補正を調整できるようにする
5. 画像処理が完了した時、システムはOCR処理用に補正された画像を表示する

### 要件 2

**ユーザーストーリー:** ユーザーとして、画像読み込み後にシステムが自動的に領収書情報を抽出してほしい。これにより、手動入力なしで迅速に構造化データを取得できる。

#### 受け入れ基準

1. 画像が処理される時、システムはonnxruntime-webとPaddleOCRの日本語軽量ONNXモデルを使用して、2段階プロセス（検出モデル→認識モデル）でOCRを実行する
2. OCR処理が完了した時、システムは4つの主要フィールドを抽出する：日付、支払先、金額、適用（利用内容）
3. 抽出結果が利用可能になった時、システムは各フィールドを `{value, confidence, candidates[]}` 構造で保存する
4. 信頼度が0.8未満の時、システムはそのフィールドに警告インジケータを表示する
5. すべてのフィールドが処理された時、システムは抽出された値を下書きエントリとしてフォームに入力する

### 要件 3

**ユーザーストーリー:** ユーザーとして、領収書画像上で手動で領域を選択して再OCRを実行したい。これにより、抽出エラーを修正したり、見逃された情報を取得できる。

#### 受け入れ基準

1. ユーザーが画像プレビュー上でドラッグした時、システムは半透明の選択オーバーレイを表示する
2. 選択が行われた時、システムは精密な選択のためのズームとパン機能をサポートする
3. ユーザーが選択を確定した時、システムは元画像を使用してその矩形領域で高解像度再OCRを実行する
4. 再OCRが完了した時、システムは選択された領域について元画像から高解像度でリサンプリングする
5. 再OCR結果が利用可能になった時、システムは関連するフィールドの候補リストに結果を追加する
6. 新しい候補が利用可能になった時、システムはユーザーが新しい結果をフォームフィールドに採用できるようにする

### 要件 4

**ユーザーストーリー:** ユーザーとして、システムが抽出されたデータを一貫した形式に正規化してほしい。これにより、出力が標準化され、会計目的で使用可能になる。

#### 受け入れ基準

1. 日付情報が抽出された時、システムはYYYY/MM/DD、YYYY-MM-DD、YYYY年M月D日、および和暦（令和/平成/昭和/大正）を含む形式を西暦形式に正規化する
2. 金額情報が抽出された時、システムは¥?\d{1,3}(,\d{3})*や\d+円のようなパターンを認識し、整数値として保存する
3. 複数の金額が検出された時、システムは「合計」、「税込」、「お会計」などのキーワード近傍の金額を優先する
4. 支払先情報が抽出された時、システムは上部領域、大きなフォント、または「株式会社」、「有限会社」、「店」、「商店」、「堂」、「薬局」などの事業者接尾辞で終わる行のテキストを優先する
5. 適用（利用内容）が抽出された時、システムは明細行から名詞句を抽出し、「会議費」や「打合せ飲食代」などの会計適切な用語を使用して1-2文で要約する

### 要件 5

**ユーザーストーリー:** ユーザーとして、抽出された領収書データをローカルでエクスポートしたい。これにより、会計や経費管理システムで情報を使用できる。

#### 受け入れ基準

1. ユーザーがデータエクスポートを要求した時、システムはJSON形式のエクスポート機能を提供する
2. ユーザーがデータエクスポートを要求した時、システムはCSV形式のエクスポート機能を提供する
3. エクスポートがトリガーされた時、システムは信頼度スコアとメタデータを含むすべての抽出フィールドを含める
4. エクスポートファイルが生成された時、システムはサーバー通信を必要とせずにローカルブラウザダウンロード機能を使用する
5. 複数の領収書が処理された時、システムは処理されたすべての領収書のバッチエクスポートをサポートする
6. エクスポート操作が発生した時、システムはすべての処理がクライアントサイドのみで実行されることを保証する